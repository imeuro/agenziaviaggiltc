jQuery(function(s){var o,l,n,i=!0,r=[],c=vivawallet_params.orderId,d=!1,m=1,v=1,u="",p=!1,h={message:null,overlayCSS:{background:"#fff",opacity:.6}};function f(e){s(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),J.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+e+"</div>"),J.removeClass("processing").unblock(),J.find(".input-text, select, input:checkbox").trigger("validate").blur(),_(),s(document.body).trigger("checkout_error")}function _(){p=!0;var e=s(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message");(e=!e.length?s("form.checkout"):e).length&&s("html, body").animate({scrollTop:e.offset().top-100},1e3)}function w(e,a){return vivawallet_params.ajax_url.toString().replace("%%endpoint%%",a+e)}var g=function(e){if(J.addClass("processing").block(h),S()&&!1===I())return f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForCCerror+"</li></ul>"),!1;var a,t="";if(!H())if(0<s("#billing_name").length)t=s("#billing_name").val().trim();else{if(!(0<s("#billing_first_name").length&&0<s("#billing_last_name").length))return f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForNameNULLerror+"</li></ul>"),!1;t=s("#billing_first_name").val().trim()+" "+s("#billing_last_name").val().trim()}if(n=s("#drpInstallments").val(),(isNaN(n)||n<=1||null===n)&&(n="1"),s('input[data-vp="cardholder"]').val(t),s('input[data-vp="accessToken"]').val(vivawallet_params.token),H()){if((a=s("input#terms")).length&&!a.is(":checked"))return f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForTermsError+"</li></ul>"),!1;s('input[data-vp="cardholder"]').val(vivawallet_params.orderCustomerName),(S()?b:k)()}else a=J.serialize(),a+="&nativeCheckoutForm=true",s.ajax({url:w("checkout",""),type:"POST",data:a,success:function(e){"success"===e.resultApi&&(c=e.orderId,vivawallet_params.checkoutSecurity=e.checkoutSecurity,vivawallet_params.cartTotalSecurity=e.cartTotalSecurity,vivawallet_params.returnUrl=e.returnUrl,d=e.saveCard,S()?y(b):y(k)),"failure"!==e.result&&"error"!==e.result||(!0===e.refresh&&(J.removeClass("processing").unblock(),s(document.body).trigger("update_checkout")),e.messages?f(e.messages):e.message&&f('<ul class="woocommerce-error" role="alert"><li>'+e.message+"</li></ul>"))},error:function(){f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForAJAXerror+"</li></ul>")}});return!1};function y(a){var e={security:vivawallet_params.cartTotalSecurity};s.ajax({type:"POST",data:e,url:w("get_cart_total_amount","wc_vivawallet_"),success:function(e){0!==e.length&&(vivawallet_params.amount=Number(e),null!==a&&a())}})}function b(){VivaPayments.cards.setup({authToken:vivawallet_params.token,baseURL:vivawallet_params.scriptUrl,cardHolderAuthOptions:{cardHolderAuthPlaceholderId:"VWpaymentContainer",cardHolderAuthInitiated:function(){s("#VWsecureModal").css({display:"flex"})},cardHolderAuthFinished:function(){s("#VWsecureModal").hide()}}}),VivaPayments.cards.requestToken({amount:100*Number(vivawallet_params.amount),installments:n}).done(function(e){o=e.chargeToken,k()}).fail(function(e){console.log("Here is the reason it failed: "+e.Error.toString()),console.dir(e)})}function k(){var e,a,t,r,r=(e=(r=(r=s('input[data-vp="cardnumber"]').val()).replace(/ /g,"")).substring(r.length-4),a=(t=s.payment.cardExpiryVal(s('input[data-vp="expdate"]').val())).month,t=t.year,r={url:w("process_payment","wc_vivawallet_"),security:vivawallet_params.checkoutSecurity,accessToken:vivawallet_params.token,chargeToken:o,cardNumberLast4:e,expiryMonth:a,expiryYear:t,cardType:s.payment.cardType(r),installments:n,savePaymentMethod:d,orderId:c,returnUrl:vivawallet_params.returnUrl,isUserLoggedIn:vivawallet_params.isUserLoggedIn},T()&&(r.paymentMethodId="10"),N()&&(r.paymentMethodId="11"),M()&&(r.paymentMethodId="13"),q()&&(r.paymentMethodId="14"),P()&&(r.paymentMethodId="15"),A()&&(r.paymentMethodId="16"),F()&&(r.paymentMethodId="17"),U()&&(r.paymentMethodId="18"),j()&&(r.paymentMethodId="19"),!H()||!1===G()&&!1!==E()||(r.relatedSubscription=G(),r.url=w("add_payment_method","wc_vivawallet_"),r.security=vivawallet_params.add_payment_method_nonce,r.installments="1",s("#update_all_subscriptions_payment_method").is(":checked")&&(r.updateAllSubscriptionsPayment=!0)),r);s.ajax({url:r.url,type:"POST",data:r,success:function(e){"success"===e.result&&e.redirect&&(window.location.href=e.redirect),"failure"===e.result&&(J.removeClass("processing").unblock(),!0!==e.reload?f('<ul class="woocommerce-error" role="alert"><li>'+e.messages+"</li></ul>"):window.location.reload())},error:function(){f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForAJAXerror+"</li></ul>")}})}var C=function(e){var a=s("#vivawallet_native-card-number"),t=s("#vivawallet_native-card-expiry"),r=s("#vivawallet_native-card-cvc"),o=a.val();o.length&&a.attr("value",o);a=t.val();a.length&&t.attr("value",a);a=r.val();a.length&&r.attr("value",a),I(),void 0!==e.target&&"vivawallet_native-card-number"!==e.target.id||(o=o.replace(/ /g,""),l&&u!==o&&(u=o,s.ajax({type:"GET",beforeSend:function(e){e.setRequestHeader("CardNumber",u),e.setRequestHeader("Authorization","Bearer "+vivawallet_params.token),e.setRequestHeader("Content-Type","application/json")},url:vivawallet_params.installmentsUrl,success:function(e){i=!0===e.requiresCvv?(s("#vivawallet_native-card-cvc").show(),s("#wc-vivawallet_native-cc-form label[for=vivawallet_native-card-cvc]").show(),!0):(s("#vivawallet_native-card-cvc").hide(),s("#wc-vivawallet_native-cc-form label[for=vivawallet_native-card-cvc]").hide(),!1),m=e.maxInstallments,H()||x(),!1===G()&&!0===E()&&x()},error:function(e){console.error("Connection to Viva Wallet API Failed"),console.log(JSON.stringify(e)),f('<ul class="woocommerce-error" role="alert"><li>'+vivawallet_params.labelForAPIerror+"</li></ul>")}})))};function I(){var e=s("#vivawallet_native-card-number"),a=s("#vivawallet_native-card-expiry"),t=s("#vivawallet_native-card-cvc");e.parent().removeClass("woocommerce-invalid woocommerce-invalid-required-field"),a.parent().removeClass("woocommerce-invalid woocommerce-invalid-required-field"),t.parent().removeClass("woocommerce-invalid woocommerce-invalid-required-field");var r=s('input[data-vp="cardnumber"]').val(),o=!0;(l=s.payment.validateCardNumber(r))||(e.parent().addClass("woocommerce-invalid woocommerce-invalid-required-field"),o=!1);e=s('input[data-vp="expdate"]').val(),e=s.payment.cardExpiryVal(e);return s.payment.validateCardExpiry(e.month.toString(),e.year.toString())||(a.parent().addClass("woocommerce-invalid woocommerce-invalid-required-field"),o=!1),i&&(s.payment.validateCardCVC(s('input[data-vp="cvv"]').val())||(t.parent().addClass("woocommerce-invalid woocommerce-invalid-required-field"),o=!1)),o}function V(e){if(void 0!==s.payment){for(var a=s.payment.cards.length,t=e.length,r=a;0<r;r--)s.payment.cards.splice(r-1,1);for(var o=0;o<t;o++)s.payment.cards.push(e[o])}else console.warn("VivaPayments: jquery.payments.js is required but not found on page load. Please  update your WooCommerce plugin.")}function x(){var e=vivawallet_params.installmentsLogic,a=vivawallet_params.allowInstallments,t=vivawallet_params.amount,r=1;if("1"===a&&1<m){if("string"==typeof e&&""!==e){for(var o=e.split(","),l=o.length,n=[],i=0;i<l;i++){var c=o[i].split(":"),d=c[0],c=c[1];Number(t)>=Number(d)&&n.push(c)}0<n.length&&(r=Math.max.apply({},n))}1<(r=m<r?m:r)?v!==r&&(function(e){s("#drpInstallments").empty(),s("#VWinstallments").show();for(var a=1;a<=e;a++){var t=a;1===t&&(t="0"),a<=e&&s("#drpInstallments").append(s("<option>").val(a).text(t))}}(r),v=r):(L(),v=1)}else L(),v=1}function L(){s("#VWinstallments").hide(),s("#drpInstallments").empty()}function W(){y(x)}function S(){return s("#payment_method_vivawallet_native").is(":checked")}function a(){return T()||N()||M()||q()||P()||A()||F()||U()||j()}function T(){return s("#payment_method_vivawallet-ideal").is(":checked")}function N(){return s("#payment_method_vivawallet-p24").is(":checked")}function M(){return s("#payment_method_vivawallet-payu").is(":checked")}function q(){return s("#payment_method_vivawallet-multibanco").is(":checked")}function P(){return s("#payment_method_vivawallet-giropay").is(":checked")}function A(){return s("#payment_method_vivawallet-directpay").is(":checked")}function F(){return s("#payment_method_vivawallet-eps").is(":checked")}function U(){return s("#payment_method_vivawallet-wechatpay").is(":checked")}function j(){return s("#payment_method_vivawallet-bitpay").is(":checked")}function H(){return!(!s("form#add_payment_method").length&&!s("form#order_review").length)}var e=window.location.search;const t=new URLSearchParams(e);function E(){return"true"===t.get("pay_for_order")}function G(){var e=t.get("change_payment_method");return null!==e&&e}function O(e=null){void 0!==e.target&&"payment_method_vivawallet_native"===e.target.id&&(!S()&&!a()||H()||W()),(S()||a()?function(){if(0!==s(".woocommerce-error").length&&!1===p&&(_(),p=!0),s(document.body).off("updated_checkout",W),s(document.body).on("updated_checkout",W),J.off("checkout_place_order",g),J.on("checkout_place_order",g),J.off("blur change keydown",C),J.on("blur change keydown",C),0!==s("form#add_payment_method").length&&(s("form#add_payment_method").off("submit",g),s("form#add_payment_method").on("submit",g)),0!==s("form#order_review").length&&(s("form#order_review").off("submit",g),s("form#order_review").on("submit",g)),0===r.length)for(var e=s.payment.cards.length,a=0;a<e;a++)r.push(s.payment.cards[a]);var t;V(R),0===s("#VWinstallments").length&&(t='<p class="form-row form-row-wide" id="VWinstallments">',t+='<label for="drpInstallments">',t+=vivawallet_params.labelForInstallments+' <span class="required">*</span>',t+='<select id="drpInstallments" name="drpInstallments"></select>',t+="</label>",t+="</p>",s("#wc-vivawallet_native-cc-form").append(t)),0===s("#VWhiddenFields").length&&(t='<div id="VWhiddenFields" style="clear: both">',t+='<input type="hidden" data-vp="cardholder" placeholder="cardholder name" />',t+='<input type="hidden" data-vp="accessToken" placeholder="card access token" autocomplete="off"/>',t+="</div>",s("#wc-vivawallet_native-cc-form").append(t)),vivawallet_params.showVWLogo&&0===s("#VWlogoContainer").length&&(t='<div class="VWLogoContainer" style="clear: both" id="VWlogoContainer">',t+="<p>",t+=vivawallet_params.labelLogoTxt,t+='<a href="https://www.vivawallet.com/" target="_blank"><img src="'+vivawallet_params.logoPath+'"></a>',t+="</p>",t+="</div>",s("#wc-vivawallet_native-cc-form").append(t)),0===s("#VWsecureModal").length&&(t='<div id="VWsecureModal">',t+='<div id="VWpaymentContainer">',t+="</div>",t+="</div>",s("body").append(t))}:function(){s(document.body).off("updated_checkout",W),J.off("checkout_place_order",g),J.off("blur change",C),0!==s("form#add_payment_method").length&&s("form#add_payment_method").off("submit",g),0!==s("form#order_review").length&&s("form#order_review").off("submit",g),V(r);var e=s("#wc-vivawallet_native-cc-form");e.find("#VWinstallments").remove(),e.find("#VWhiddenFields").remove(),e.find("#VWlogoContainer").remove(),e.find("#VWsecureModal").remove(),v=1})()}e=/(\d{1,4})/g;let R=[{type:"bancontact",patterns:[48107907,487104,487109,606005,6703],format:e,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"maestro",patterns:[5018,502,503,506,56,58,606005,639,6220,67],format:e,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"forbrugsforeningen",patterns:[600],format:e,length:[16],cvcLength:[3],luhn:!0},{type:"dankort",patterns:[5019],format:e,length:[16],cvcLength:[3],luhn:!0},{type:"visa",patterns:[4],format:e,length:[13,16,19],cvcLength:[3],luhn:!0},{type:"mastercard",patterns:[5,51,52,53,54,55,59,22,23,24,25,26,27],format:e,length:[16,18,19],cvcLength:[3],luhn:!0},{type:"amex",patterns:[34,37],format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"dinersclub",patterns:[30,36,38,39],format:/(\d{1,4})(\d{1,6})?(\d{1,4})?/,length:[14],cvcLength:[3],luhn:!0},{type:"discover",patterns:[6011],format:e,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",patterns:[62,88],format:e,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"jcb",patterns:[35],format:e,length:[16],cvcLength:[3],luhn:!0}];var J=s("form.woocommerce-checkout");s("form#add_payment_method").length&&(J=s("form#add_payment_method")),s("form#order_review").length&&(J=s("form#order_review")),s(O),s("#vivawallet_native-card-cvc").attr("autocomplete","cc-csc"),J.on("change",function(e){O(e)})});